# WMS Med@x - Documenta√ß√£o do M√≥dulo Estoque

**Data:** Janeiro 2026  
**Vers√£o:** 1.0  
**M√≥dulo:** Estoque (Stock)  
**Status:** ‚úÖ Implementado e Funcional

---

## üìã √çndice

1. [Vis√£o Geral](#vis√£o-geral)
2. [Funcionalidades Principais](#funcionalidades-principais)
3. [Arquitetura T√©cnica](#arquitetura-t√©cnica)
4. [Backend - C√≥digo Completo](#backend---c√≥digo-completo)
5. [Frontend - C√≥digo Completo](#frontend---c√≥digo-completo)
6. [Fluxos Operacionais](#fluxos-operacionais)
7. [Integra√ß√£o com Outros M√≥dulos](#integra√ß√£o-com-outros-m√≥dulos)

---

## Vis√£o Geral

O **M√≥dulo Estoque** √© respons√°vel pela gest√£o de invent√°rio, movimenta√ß√µes, posi√ß√µes de estoque e dashboards de ocupa√ß√£o do armaz√©m. Fornece visibilidade completa do estoque em tempo real com filtros avan√ßados, exporta√ß√£o de relat√≥rios e sugest√µes de otimiza√ß√£o.

### Caracter√≠sticas Principais

- ‚úÖ Consulta de posi√ß√µes de estoque em tempo real
- ‚úÖ Movimenta√ß√µes entre endere√ßos com valida√ß√£o de saldo
- ‚úÖ Dashboard de ocupa√ß√£o por zona
- ‚úÖ Sugest√µes inteligentes de otimiza√ß√£o
- ‚úÖ Exporta√ß√£o de relat√≥rios em Excel (.xlsx)
- ‚úÖ Hist√≥rico completo de movimenta√ß√µes
- ‚úÖ Sincroniza√ß√£o autom√°tica de saldos
- ‚úÖ Integra√ß√£o com sistema de endere√ßamento

---

## Funcionalidades Principais

### 1. Posi√ß√µes de Estoque (/stock)

**Descri√ß√£o:** Consulta centralizada de todas as posi√ß√µes de estoque com filtros avan√ßados.

**Funcionalidades:**
- Listagem de posi√ß√µes com pagina√ß√£o
- Filtros por: Cliente, Zona, Status, Lote, Endere√ßo, Busca geral
- Cards de resumo: Total de Posi√ß√µes, Quantidade Total, Endere√ßos Ocupados, Lotes √önicos
- Legenda visual de status (Dispon√≠vel, Ocupado, Bloqueado, Em Contagem)
- Exporta√ß√£o para Excel (.xlsx)
- Atualiza√ß√£o em tempo real

**Colunas da Tabela:**
| Coluna | Descri√ß√£o | Tipo |
|--------|-----------|------|
| Cliente | Nome do tenant | String |
| Zona | Nome da zona de armazenagem | String |
| Endere√ßo | C√≥digo do endere√ßo (ex: M01-01-02A) | String |
| Status | Status do endere√ßo (Ocupado, Dispon√≠vel, etc) | Badge |
| SKU | C√≥digo do produto | String |
| Produto | Descri√ß√£o do produto | String |
| Lote | N√∫mero do lote | String |
| Quantidade | Quantidade em estoque | Number |
| Validade | Data de validade | Date |

### 2. Movimenta√ß√µes de Estoque (/stock/movements)

**Descri√ß√£o:** Interface para registrar movimenta√ß√µes entre endere√ßos com valida√ß√£o inteligente.

**Tipos de Movimenta√ß√£o:**
- **transfer** - Transfer√™ncia entre endere√ßos
- **adjustment** - Ajuste de quantidade (entrada/sa√≠da)
- **return** - Devolu√ß√£o de produto
- **disposal** - Descarte/destrui√ß√£o

**Funcionalidades:**
- Sele√ß√£o de endere√ßo origem com lista de produtos dispon√≠veis
- Valida√ß√£o autom√°tica de saldo
- Sugest√£o inteligente de endere√ßo destino (pr√©-aloca√ß√£o ou endere√ßo livre)
- Hist√≥rico de movimenta√ß√µes com filtros
- Feedback visual com badges de tipo de movimenta√ß√£o
- Integra√ß√£o com regras de armazenagem

**Fluxo de Movimenta√ß√£o:**
1. Selecionar endere√ßo origem
2. Sistema lista produtos/lotes dispon√≠veis
3. Selecionar produto/lote
4. Informar quantidade (m√°ximo = saldo dispon√≠vel)
5. Sistema sugere endere√ßo destino automaticamente
6. Confirmar movimenta√ß√£o
7. Sistema atualiza saldos e status de endere√ßos

### 3. Dashboard de Ocupa√ß√£o (/occupancy)

**Descri√ß√£o:** Visualiza√ß√£o gr√°fica da ocupa√ß√£o do armaz√©m por zona.

**Componentes:**
- **Gr√°fico de Barras Empilhadas:** Ocupa√ß√£o % por zona (Ocupados vs Dispon√≠veis)
- **Tabela Detalhada:** Ocupados, Dispon√≠veis, Bloqueados, Em Contagem por zona
- **Cards de M√©tricas:** Ocupa√ß√£o geral, Endere√ßos totais, Capacidade cr√≠tica
- **Sugest√µes de Otimiza√ß√£o:** Alertas e recomenda√ß√µes baseadas em padr√µes

**Sugest√µes de Otimiza√ß√£o:**
1. **Consolida√ß√£o** - Zonas com <10% ocupa√ß√£o
2. **Capacidade Cr√≠tica** - Zonas com 80-90% ocupa√ß√£o
3. **Realoca√ß√£o** - Produtos fragmentados em >3 endere√ßos
4. **Efici√™ncia** - Baixa utiliza√ß√£o geral ou endere√ßos bloqueados

### 4. Exporta√ß√£o de Relat√≥rios

**Descri√ß√£o:** Exporta√ß√£o de posi√ß√£o de estoque em formato Excel (.xlsx).

**Funcionalidades:**
- Exporta√ß√£o com filtros aplicados
- Op√ß√£o de incluir/excluir endere√ßos vazios
- Colunas: Endere√ßo, Zona, SKU, Descri√ß√£o, Lote, Quantidade, Validade, Status, Cliente
- Endere√ßos multi-item geram uma linha por SKU
- Download autom√°tico do arquivo

---

## Arquitetura T√©cnica

### Tabelas de Banco de Dados

```sql
-- Tabela de Saldos de Estoque (consolidado)
CREATE TABLE inventory (
  id INT PRIMARY KEY AUTO_INCREMENT,
  productId INT NOT NULL,
  locationId INT NOT NULL,
  batch VARCHAR(50),
  quantity DECIMAL(10, 2) NOT NULL,
  status ENUM('available', 'quarantine', 'blocked', 'damaged', 'expired'),
  expiryDate DATE,
  tenantId INT,
  createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (productId) REFERENCES products(id),
  FOREIGN KEY (locationId) REFERENCES warehouseLocations(id),
  FOREIGN KEY (tenantId) REFERENCES tenants(id),
  INDEX idx_product_location (productId, locationId),
  INDEX idx_status (status),
  INDEX idx_expiry (expiryDate)
);

-- Tabela de Hist√≥rico de Movimenta√ß√µes
CREATE TABLE inventoryMovements (
  id INT PRIMARY KEY AUTO_INCREMENT,
  inventoryId INT,
  productId INT NOT NULL,
  fromLocationId INT,
  toLocationId INT,
  quantity DECIMAL(10, 2) NOT NULL,
  batch VARCHAR(50),
  movementType ENUM('receiving', 'picking', 'transfer', 'adjustment', 'return', 'disposal'),
  notes TEXT,
  createdBy INT,
  createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (inventoryId) REFERENCES inventory(id),
  FOREIGN KEY (productId) REFERENCES products(id),
  FOREIGN KEY (fromLocationId) REFERENCES warehouseLocations(id),
  FOREIGN KEY (toLocationId) REFERENCES warehouseLocations(id),
  FOREIGN KEY (createdBy) REFERENCES systemUsers(id),
  INDEX idx_movement_type (movementType),
  INDEX idx_created_at (createdAt),
  INDEX idx_product (productId)
);

-- Tabela de Mapeamento de Localiza√ß√£o Sugerida
CREATE TABLE productLocationMapping (
  id INT PRIMARY KEY AUTO_INCREMENT,
  productId INT NOT NULL,
  locationId INT NOT NULL,
  priority INT DEFAULT 1,
  tenantId INT,
  createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (productId) REFERENCES products(id),
  FOREIGN KEY (locationId) REFERENCES warehouseLocations(id),
  FOREIGN KEY (tenantId) REFERENCES tenants(id),
  UNIQUE KEY unique_product_location (productId, locationId),
  INDEX idx_priority (priority)
);
```

### Interfaces TypeScript

```typescript
// Filtros para consulta de estoque
export interface InventoryFilters {
  tenantId?: number | null;
  productId?: number;
  locationId?: number;
  zoneId?: number;
  batch?: string;
  status?: "available" | "quarantine" | "blocked" | "damaged" | "expired";
  minQuantity?: number;
  search?: string;
}

// Posi√ß√£o de estoque
export interface InventoryPosition {
  id: number;
  productId: number;
  productSku: string;
  productDescription: string;
  locationId: number;
  locationCode: string;
  locationStatus: string;
  zoneName: string;
  batch: string | null;
  expiryDate: Date | null;
  quantity: number;
  status: string;
  tenantId: number | null;
  tenantName: string | null;
  createdAt: Date;
  updatedAt: Date;
}

// Movimenta√ß√£o de estoque
export interface StockMovement {
  id: number;
  productId: number;
  fromLocationId?: number;
  toLocationId?: number;
  quantity: number;
  batch?: string;
  movementType: "receiving" | "picking" | "transfer" | "adjustment" | "return" | "disposal";
  notes?: string;
  fromLocationCode?: string;
  toLocationCode?: string;
  createdAt: Date;
  createdByName?: string;
}

// Sugest√£o de otimiza√ß√£o
export interface OptimizationSuggestion {
  id: string;
  type: "consolidation" | "capacity_critical" | "reallocation" | "efficiency";
  priority: "high" | "medium" | "low";
  title: string;
  description: string;
  impact: string;
  actions: string[];
  metrics: {
    current: number;
    target: number;
    unit: string;
  };
}
```

---

## Backend - C√≥digo Completo

### server/inventory.ts - Consulta de Estoque

```typescript
import { alias, eq, gte, like, isNull, sql } from "drizzle-orm";
import { getDb } from "./db";
import {
  inventory,
  products,
  warehouseLocations,
  warehouseZones,
  tenants,
} from "../drizzle/schema";

export interface InventoryFilters {
  tenantId?: number | null;
  productId?: number;
  locationId?: number;
  zoneId?: number;
  batch?: string;
  status?: "available" | "quarantine" | "blocked" | "damaged" | "expired";
  minQuantity?: number;
  search?: string;
}

export interface InventoryPosition {
  id: number;
  productId: number;
  productSku: string;
  productDescription: string;
  locationId: number;
  locationCode: string;
  locationStatus: string;
  zoneName: string;
  batch: string | null;
  expiryDate: Date | null;
  quantity: number;
  status: string;
  tenantId: number | null;
  tenantName: string | null;
  createdAt: Date;
  updatedAt: Date;
}

/**
 * Consulta posi√ß√µes de estoque com filtros avan√ßados
 */
export async function getInventoryPositions(
  filters: InventoryFilters
): Promise<InventoryPosition[]> {
  const dbConn = await getDb();
  if (!dbConn) throw new Error("Database connection failed");

  const conditions = [];

  // Filtro por tenant
  if (filters.tenantId !== undefined) {
    if (filters.tenantId === null) {
      conditions.push(isNull(inventory.tenantId));
    } else {
      conditions.push(eq(inventory.tenantId, filters.tenantId));
    }
  }

  // Filtros adicionais
  if (filters.productId) {
    conditions.push(eq(inventory.productId, filters.productId));
  }
  if (filters.locationId) {
    conditions.push(eq(inventory.locationId, filters.locationId));
  }
  if (filters.batch) {
    conditions.push(like(inventory.batch, `%${filters.batch}%`));
  }
  if (filters.status) {
    conditions.push(eq(inventory.status, filters.status));
  }
  if (filters.minQuantity !== undefined) {
    conditions.push(gte(inventory.quantity, filters.minQuantity));
  }

  // Busca por SKU ou descri√ß√£o
  if (filters.search) {
    conditions.push(
      sql`(${products.sku} LIKE ${`%${filters.search}%`} OR ${products.description} LIKE ${`%${filters.search}%`})`
    );
  }

  // Criar aliases para tenant
  const locationTenant = alias(tenants, 'locationTenant');
  
  const results = await dbConn
    .select({
      id: inventory.id,
      productId: inventory.productId,
      productSku: products.sku,
      productDescription: products.description,
      locationId: inventory.locationId,
      locationCode: warehouseLocations.code,
      locationStatus: warehouseLocations.status,
      zoneName: warehouseZones.name,
      batch: inventory.batch,
      expiryDate: inventory.expiryDate,
      quantity: inventory.quantity,
      status: inventory.status,
      tenantId: warehouseLocations.tenantId,
      tenantName: locationTenant.name,
      createdAt: inventory.createdAt,
      updatedAt: inventory.updatedAt,
    })
    .from(inventory)
    .innerJoin(products, eq(inventory.productId, products.id))
    .innerJoin(warehouseLocations, eq(inventory.locationId, warehouseLocations.id))
    .innerJoin(warehouseZones, eq(warehouseLocations.zoneId, warehouseZones.id))
    .leftJoin(locationTenant, eq(warehouseLocations.tenantId, locationTenant.id))
    .where(conditions.length > 0 ? and(...conditions) : undefined)
    .orderBy(warehouseLocations.code, inventory.batch)
    .limit(1000);

  return results;
}

/**
 * Obt√©m saldo total de um produto
 */
export async function getProductTotalStock(productId: number): Promise<number> {
  const dbConn = await getDb();
  if (!dbConn) throw new Error("Database connection failed");

  const result = await dbConn
    .select({ total: sql<number>`SUM(${inventory.quantity})` })
    .from(inventory)
    .where(eq(inventory.productId, productId));

  return result[0]?.total ?? 0;
}

/**
 * Obt√©m saldo de um endere√ßo espec√≠fico
 */
export async function getLocationStock(
  locationId: number,
  productId?: number,
  batch?: string
