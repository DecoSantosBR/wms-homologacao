{
  "query": "\n-- Recalcular reservedQuantity para TODOS os registros de estoque\n-- baseado apenas em pedidos ativos\nUPDATE inventory i\nLEFT JOIN (\n  SELECT \n    poi.productId,\n    poi.batch,\n    SUM(\n      CASE \n        WHEN poi.unit = 'box' THEN poi.requestedQuantity * COALESCE(p.unitsPerBox, 1)\n        ELSE poi.requestedQuantity\n      END\n    ) as totalReserved\n  FROM pickingOrderItems poi\n  INNER JOIN pickingOrders po ON poi.pickingOrderId = po.id\n  INNER JOIN products p ON poi.productId = p.id\n  WHERE po.status IN ('pending', 'in_progress', 'separated', 'in_wave')\n  GROUP BY poi.productId, poi.batch\n) active_reserves ON i.productId = active_reserves.productId \n  AND (i.batch = active_reserves.batch OR (i.batch IS NULL AND active_reserves.batch IS NULL))\nSET i.reservedQuantity = COALESCE(active_reserves.totalReserved, 0)\nWHERE i.reservedQuantity != COALESCE(active_reserves.totalReserved, 0);\n\n-- Verificar resultado\nSELECT \n  COUNT(*) as totalRegistrosCorrigidos,\n  SUM(CASE WHEN reservedQuantity > 0 THEN 1 ELSE 0 END) as registrosComReserva,\n  SUM(reservedQuantity) as totalReservado\nFROM inventory;\n",
  "command": "mysql --batch --raw --column-names --default-character-set=utf8mb4 --host gateway02.us-east-1.prod.aws.tidbcloud.com --port 4000 --user 44TTARZqZm4zxSK.6207e12656da --database YB8JBMXFWs4i38ecUvjPnS --execute \n-- Recalcular reservedQuantity para TODOS os registros de estoque\n-- baseado apenas em pedidos ativos\nUPDATE inventory i\nLEFT JOIN (\n  SELECT \n    poi.productId,\n    poi.batch,\n    SUM(\n      CASE \n        WHEN poi.unit = 'box' THEN poi.requestedQuantity * COALESCE(p.unitsPerBox, 1)\n        ELSE poi.requestedQuantity\n      END\n    ) as totalReserved\n  FROM pickingOrderItems poi\n  INNER JOIN pickingOrders po ON poi.pickingOrderId = po.id\n  INNER JOIN products p ON poi.productId = p.id\n  WHERE po.status IN ('pending', 'in_progress', 'separated', 'in_wave')\n  GROUP BY poi.productId, poi.batch\n) active_reserves ON i.productId = active_reserves.productId \n  AND (i.batch = active_reserves.batch OR (i.batch IS NULL AND active_reserves.batch IS NULL))\nSET i.reservedQuantity = COALESCE(active_reserves.totalReserved, 0)\nWHERE i.reservedQuantity != COALESCE(active_reserves.totalReserved, 0);\n\n-- Verificar resultado\nSELECT \n  COUNT(*) as totalRegistrosCorrigidos,\n  SUM(CASE WHEN reservedQuantity > 0 THEN 1 ELSE 0 END) as registrosComReserva,\n  SUM(reservedQuantity) as totalReservado\nFROM inventory;\n",
  "rows": [
    {
      "totalRegistrosCorrigidos": "9",
      "registrosComReserva": "0",
      "totalReservado": "0"
    }
  ],
  "messages": [],
  "stdout": "totalRegistrosCorrigidos\tregistrosComReserva\ttotalReservado\n9\t0\t0\n",
  "stderr": "",
  "execution_time_ms": 405
}