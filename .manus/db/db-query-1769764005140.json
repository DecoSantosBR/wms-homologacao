{
  "query": "\n-- Identificar reservas órfãs: estoque com reservedQuantity > 0 mas sem pedidos ativos correspondentes\nSELECT \n  i.id as inventoryId,\n  p.sku,\n  p.description as productName,\n  i.batch,\n  wl.code as locationCode,\n  wz.name as zoneName,\n  i.quantity as totalQuantity,\n  i.reservedQuantity,\n  (i.quantity - i.reservedQuantity) as availableQuantity,\n  -- Calcular reservas reais de pedidos ativos\n  COALESCE(active_reserves.totalReserved, 0) as reservasReaisAtivas,\n  -- Diferença = reserva órfã\n  (i.reservedQuantity - COALESCE(active_reserves.totalReserved, 0)) as reservaOrfa\nFROM inventory i\nINNER JOIN products p ON i.productId = p.id\nINNER JOIN warehouseLocations wl ON i.locationId = wl.id\nINNER JOIN warehouseZones wz ON wl.zoneId = wz.id\nLEFT JOIN (\n  SELECT \n    poi.productId,\n    poi.batch,\n    SUM(\n      CASE \n        WHEN poi.unit = 'box' THEN poi.requestedQuantity * COALESCE(p.unitsPerBox, 1)\n        ELSE poi.requestedQuantity\n      END\n    ) as totalReserved\n  FROM pickingOrderItems poi\n  INNER JOIN pickingOrders po ON poi.pickingOrderId = po.id\n  INNER JOIN products p ON poi.productId = p.id\n  WHERE po.status IN ('pending', 'in_progress', 'separated', 'in_wave')\n  GROUP BY poi.productId, poi.batch\n) active_reserves ON i.productId = active_reserves.productId \n  AND (i.batch = active_reserves.batch OR (i.batch IS NULL AND active_reserves.batch IS NULL))\nWHERE i.reservedQuantity > 0\n  AND i.reservedQuantity != COALESCE(active_reserves.totalReserved, 0)\nORDER BY (i.reservedQuantity - COALESCE(active_reserves.totalReserved, 0)) DESC;\n",
  "command": "mysql --batch --raw --column-names --default-character-set=utf8mb4 --host gateway02.us-east-1.prod.aws.tidbcloud.com --port 4000 --user 44TTARZqZm4zxSK.6207e12656da --database YB8JBMXFWs4i38ecUvjPnS --execute \n-- Identificar reservas órfãs: estoque com reservedQuantity > 0 mas sem pedidos ativos correspondentes\nSELECT \n  i.id as inventoryId,\n  p.sku,\n  p.description as productName,\n  i.batch,\n  wl.code as locationCode,\n  wz.name as zoneName,\n  i.quantity as totalQuantity,\n  i.reservedQuantity,\n  (i.quantity - i.reservedQuantity) as availableQuantity,\n  -- Calcular reservas reais de pedidos ativos\n  COALESCE(active_reserves.totalReserved, 0) as reservasReaisAtivas,\n  -- Diferença = reserva órfã\n  (i.reservedQuantity - COALESCE(active_reserves.totalReserved, 0)) as reservaOrfa\nFROM inventory i\nINNER JOIN products p ON i.productId = p.id\nINNER JOIN warehouseLocations wl ON i.locationId = wl.id\nINNER JOIN warehouseZones wz ON wl.zoneId = wz.id\nLEFT JOIN (\n  SELECT \n    poi.productId,\n    poi.batch,\n    SUM(\n      CASE \n        WHEN poi.unit = 'box' THEN poi.requestedQuantity * COALESCE(p.unitsPerBox, 1)\n        ELSE poi.requestedQuantity\n      END\n    ) as totalReserved\n  FROM pickingOrderItems poi\n  INNER JOIN pickingOrders po ON poi.pickingOrderId = po.id\n  INNER JOIN products p ON poi.productId = p.id\n  WHERE po.status IN ('pending', 'in_progress', 'separated', 'in_wave')\n  GROUP BY poi.productId, poi.batch\n) active_reserves ON i.productId = active_reserves.productId \n  AND (i.batch = active_reserves.batch OR (i.batch IS NULL AND active_reserves.batch IS NULL))\nWHERE i.reservedQuantity > 0\n  AND i.reservedQuantity != COALESCE(active_reserves.totalReserved, 0)\nORDER BY (i.reservedQuantity - COALESCE(active_reserves.totalReserved, 0)) DESC;\n",
  "rows": [
    {
      "inventoryId": "270007",
      "sku": "443060",
      "productName": "EXTENSOFIX 60 CM",
      "batch": "22D14LA124",
      "locationCode": "H01-01-01",
      "zoneName": "Carga Seca",
      "totalQuantity": "0",
      "reservedQuantity": "280",
      "availableQuantity": "-280",
      "reservasReaisAtivas": "0",
      "reservaOrfa": "280"
    },
    {
      "inventoryId": "270008",
      "sku": "401460P",
      "productName": "INTRAFIX PRIMELINE AIR",
      "batch": "22D08LB108",
      "locationCode": "H01-01-02",
      "zoneName": "Carga Seca",
      "totalQuantity": "0",
      "reservedQuantity": "160",
      "availableQuantity": "-160",
      "reservasReaisAtivas": "0",
      "reservaOrfa": "160"
    },
    {
      "inventoryId": "270009",
      "sku": "834207",
      "productName": "PERFUSOR SET 60 CM",
      "batch": "22D08LA129",
      "locationCode": "H01-01-03",
      "zoneName": "Carga Seca",
      "totalQuantity": "0",
      "reservedQuantity": "140",
      "availableQuantity": "-140",
      "reservasReaisAtivas": "0",
      "reservaOrfa": "140"
    }
  ],
  "messages": [],
  "stdout": "inventoryId\tsku\tproductName\tbatch\tlocationCode\tzoneName\ttotalQuantity\treservedQuantity\tavailableQuantity\treservasReaisAtivas\treservaOrfa\n270007\t443060\tEXTENSOFIX 60 CM\t22D14LA124\tH01-01-01\tCarga Seca\t0\t280\t-280\t0\t280\n270008\t401460P\tINTRAFIX PRIMELINE AIR\t22D08LB108\tH01-01-02\tCarga Seca\t0\t160\t-160\t0\t160\n270009\t834207\tPERFUSOR SET 60 CM\t22D08LA129\tH01-01-03\tCarga Seca\t0\t140\t-140\t0\t140\n",
  "stderr": "",
  "execution_time_ms": 360
}