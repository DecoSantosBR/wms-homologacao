{
  "query": "-- Criar tabela temporária com reservas corretas\nCREATE TEMPORARY TABLE IF NOT EXISTS correct_reserves AS\nSELECT \n  i.id as inventoryId,\n  i.productId,\n  i.tenantId,\n  i.locationId,\n  i.batch,\n  i.quantity as currentQuantity,\n  i.reservedQuantity as oldReservedQuantity,\n  COALESCE(SUM(poi.requestedQuantity), 0) as correctReservedQuantity\nFROM inventory i\nLEFT JOIN pickingOrderItems poi ON \n  i.productId = poi.productId \n  AND i.batch = poi.batch\nLEFT JOIN pickingOrders po ON poi.pickingOrderId = po.id\nWHERE po.status IN ('pending', 'in_progress', 'separated') OR po.id IS NULL\nGROUP BY i.id, i.productId, i.tenantId, i.locationId, i.batch, i.quantity, i.reservedQuantity;\n\n-- Atualizar inventory com valores corretos\nUPDATE inventory i\nINNER JOIN correct_reserves cr ON i.id = cr.inventoryId\nSET i.reservedQuantity = cr.correctReservedQuantity\nWHERE i.reservedQuantity != cr.correctReservedQuantity;\n\n-- Mostrar correções aplicadas\nSELECT \n  inventoryId,\n  productId,\n  locationId,\n  batch,\n  currentQuantity,\n  oldReservedQuantity,\n  correctReservedQuantity,\n  (currentQuantity - correctReservedQuantity) as newAvailable\nFROM correct_reserves\nWHERE oldReservedQuantity != correctReservedQuantity;\n\n-- Limpar tabela temporária\nDROP TEMPORARY TABLE IF EXISTS correct_reserves;",
  "command": "mysql --batch --raw --column-names --default-character-set=utf8mb4 --host gateway02.us-east-1.prod.aws.tidbcloud.com --port 4000 --user 44TTARZqZm4zxSK.6207e12656da --database YB8JBMXFWs4i38ecUvjPnS --execute -- Criar tabela temporária com reservas corretas\nCREATE TEMPORARY TABLE IF NOT EXISTS correct_reserves AS\nSELECT \n  i.id as inventoryId,\n  i.productId,\n  i.tenantId,\n  i.locationId,\n  i.batch,\n  i.quantity as currentQuantity,\n  i.reservedQuantity as oldReservedQuantity,\n  COALESCE(SUM(poi.requestedQuantity), 0) as correctReservedQuantity\nFROM inventory i\nLEFT JOIN pickingOrderItems poi ON \n  i.productId = poi.productId \n  AND i.batch = poi.batch\nLEFT JOIN pickingOrders po ON poi.pickingOrderId = po.id\nWHERE po.status IN ('pending', 'in_progress', 'separated') OR po.id IS NULL\nGROUP BY i.id, i.productId, i.tenantId, i.locationId, i.batch, i.quantity, i.reservedQuantity;\n\n-- Atualizar inventory com valores corretos\nUPDATE inventory i\nINNER JOIN correct_reserves cr ON i.id = cr.inventoryId\nSET i.reservedQuantity = cr.correctReservedQuantity\nWHERE i.reservedQuantity != cr.correctReservedQuantity;\n\n-- Mostrar correções aplicadas\nSELECT \n  inventoryId,\n  productId,\n  locationId,\n  batch,\n  currentQuantity,\n  oldReservedQuantity,\n  correctReservedQuantity,\n  (currentQuantity - correctReservedQuantity) as newAvailable\nFROM correct_reserves\nWHERE oldReservedQuantity != correctReservedQuantity;\n\n-- Limpar tabela temporária\nDROP TEMPORARY TABLE IF EXISTS correct_reserves;",
  "returncode": 1,
  "logs": [
    "ERROR 1105 (HY000) at line 2: 'CREATE TABLE ... SELECT' is not implemented yet"
  ]
}